# UBTECH CAN 서보 진단 보고서

## 테스트 일시
2024-11-23

## 테스트 환경
- **포트**: COM7 (USB-SERIAL CH340)
- **보레이트**: 115200
- **CAN 속도**: 1 Mbps
- **MCP2515 크리스탈**: 16 MHz

## 하드웨어 상태

### MCP2515 CAN 모듈
- ✅ **초기화**: 성공
- ✅ **설정 모드 진입**: 성공
- ✅ **보레이트 설정**: 성공 (1 Mbps)
- ✅ **Normal 모드 전환**: 성공
- ✅ **클럭 확인**: 16 MHz 정상

### 서보 모터 검색 결과
아두이노가 ID 1~20 범위를 개별 스캔한 결과:

#### 발견된 모터 (2개)
| ID | 위치 | 상태 |
|----|------|------|
| 1  | 179.7° | ✅ 정상 응답 |
| 7  | 179.7° | ✅ 정상 응답 |

#### 응답 없는 ID (5개)
- ID 2, 3, 4, 5, 6: **응답 없음**

## 문제 분석

### 주요 발견사항
1. **물리적으로 ID 2-6 모터가 CAN 버스에 연결되어 있지 않거나 통신 불가**
2. ID 1과 ID 7 모터는 정상 통신
3. 스캔 방식: 개별 ID 스캔 (MCP2515 RX 버퍼 오버플로우 방지)

### 가능한 원인

#### 1. 물리적 연결 문제 ⚠️ (가장 가능성 높음)
- CAN-H, CAN-L 배선이 데이지 체인으로 연결되지 않음
- ID 2-6 모터가 CAN 버스에서 물리적으로 분리됨
- 커넥터 접촉 불량

**확인 방법:**
```
1. 모든 모터의 CAN-H, CAN-L 연결 확인
2. 데이지 체인 연결 순서 확인
   - Controller → Motor 1 → Motor 2 → ... → Motor 7
3. 각 모터의 전원 연결 확인
```

#### 2. 전원 공급 문제 🔋
- ID 2-6 모터에 전원이 공급되지 않음
- 전원 용량 부족으로 일부 모터만 작동

**확인 방법:**
```
1. 각 모터의 전원 LED 확인
2. 전원 공급 장치의 전압/전류 용량 확인
3. 전원선 연결 상태 확인
```

#### 3. 모터 ID 설정 오류 🔢
- 실제 모터 ID가 1, 7만 설정되어 있음
- ID 2-6이 다른 ID로 설정되었거나 미설정

**확인 방법:**
```arduino
// 아두이노 메뉴에서 다음 테스트 수행
1. 메뉴 '1: Search' - 재검색
2. 메뉴 '3: Monitor' - CAN 버스 모니터링
3. 메뉴 '8: Read Info' - ID 1, 7 상세 정보 읽기
```

#### 4. CAN 버스 종단 저항 문제 🔌
- 120Ω 종단 저항이 제대로 설치되지 않음
- 긴 케이블에서 반사로 인한 통신 오류

**확인 방법:**
```
1. CAN-H와 CAN-L 사이 저항 측정 (약 60Ω = 120Ω || 120Ω)
2. 버스 양 끝단에 120Ω 저항 설치 확인
```

#### 5. 통신 속도 불일치 ⚡
- 일부 모터가 1 Mbps를 지원하지 않음
- 모터별로 다른 통신 속도로 설정됨

**확인 방법:**
```arduino
// 아두이노 메뉴 '6: Try 500kbps' 실행
// 500 kbps로 변경 후 재검색
```

## 권장 조치 사항

### 즉시 확인 사항 (우선순위 순)

#### 1단계: 물리적 연결 확인
```
[ ] 모든 모터의 전원 LED가 켜져 있는지 확인
[ ] CAN-H, CAN-L 배선이 모든 모터에 연결되었는지 확인
[ ] 커넥터 연결 상태 재확인 (뽑았다가 다시 꽂기)
[ ] 전원 공급 장치 출력 전압 측정
```

#### 2단계: 아두이노 메뉴로 추가 진단
```bash
# Python 대화형 터미널 실행
python arduino_terminal.py

# 아두이노 메뉴에서 수행할 작업:
1. '1' 입력 - 서보 재검색
2. '3' 입력 - CAN 버스 모니터 시작 (수동으로 모터 움직여보기)
3. '5' 입력 - MCP2515 상태 확인
4. '6' 입력 - 500 kbps로 속도 변경 후 재검색
5. '8' 입력 - ID 1 정보 읽기
6. '8' 입력 - ID 7 정보 읽기
```

#### 3단계: 개별 모터 테스트
각 모터를 개별적으로 연결하여 테스트:
```
1. 모터 1개만 연결 → ID 확인
2. 다음 모터 추가 → ID 확인
3. 반복하여 어느 모터에서 문제가 발생하는지 파악
```

#### 4단계: 배선도 확인
```
Controller (MCP2515)
    |
    ├─ CAN-H ──┬── [120Ω] ── Motor Chain ── [120Ω]
    └─ CAN-L ──┘
    
Motor Chain:
    Motor 1 ── Motor 2 ── Motor 3 ── ... ── Motor 7
    (데이지 체인)
```

## 테스트 스크립트

### 대화형 터미널 사용
```bash
python arduino_terminal.py
```

### 시리얼 모니터
```bash
python serial_monitor.py
```

## 다음 단계

현재 **ID 1과 ID 7 모터만 통신 가능**한 상태입니다. 

**즉시 확인해야 할 사항:**
1. 🔴 **ID 2-6 모터의 물리적 연결 상태**
2. 🔴 **모든 모터의 전원 공급 상태**
3. 🟡 **CAN 버스 배선의 데이지 체인 구조**
4. 🟡 **종단 저항 설치 여부**

위 확인 후에도 문제가 해결되지 않으면:
- 아두이노 메뉴의 '3: Monitor'로 CAN 버스 트래픽 관찰
- 각 모터를 개별적으로 연결하여 ID 확인
- 통신 속도를 500 kbps로 낮춰서 테스트

## 참고
- 아두이노 코드: `arduino/CAN_Type_Test/CAN_Type_Test.ino`
- 테스트 스크립트: `test_serial_direct.py`, `serial_monitor.py`, `arduino_terminal.py`
