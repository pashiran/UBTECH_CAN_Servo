# UBTECH 서보모터 CAN 프로토콜 (60kg/25kg)

> 파일명: 05_UBTECH_서보_프로토콜_CAN.md

# UBTECH 서보모터 60kg/25kg CAN 통신 프로토콜

## 목차
- [개요](#개요)
- [서보모터 기능](#서보모터-기능)
  - [각도 및 속도 제어 (운동 제어)](#각도-및-속도-제어-운동-제어)
  - [서보모터 영점 수정](#서보모터-영점-수정)
  - [서보모터 잠금/해제](#서보모터-잠금해제)
  - [서보모터 상태 조회](#서보모터-상태-조회)
  - [서보모터 ID 수정](#서보모터-id-수정)
- [하드웨어 준비](#하드웨어-준비)
- [상위기 디버깅 및 파라미터 설정](#상위기-디버깅-및-파라미터-설정)
- [서보모터 통신 프로토콜 해석 및 예제](#서보모터-통신-프로토콜-해석-및-예제)
  - [명령 패킷](#명령-패킷)
  - [응답 패킷](#응답-패킷)
  - [명령 타입](#명령-타입)
  - [예제 1: 운동 제어](#예제-1-운동-제어)
  - [예제 2: 조회](#예제-2-조회)
  - [예제 3: 서보모터 ID 수정](#예제-3-서보모터-id-수정)
  - [예제 4: 서보모터 잠금과 해제](#예제-4-서보모터-잠금과-해제)

---

## 개요

![60kg 서보모터](./images/servo_60kg.png)
![25kg 서보모터](./images/servo_25kg.png)

서보모터는 ARM 32비트 마이크로컨트롤러를 주 제어 코어로 사용하며, 위치 감지는 360도 12비트 정밀도의 자기 감지 각도 방식을 채택하고, 통신은 CAN 프로토콜을 사용합니다.

---

## 서보모터 기능

현재 탐색된 서보모터의 기능은 다음과 같습니다:

### 각도 및 속도 제어 (운동 제어)
- **각도 제어 범위**: 0-360도
- **제어 정밀도**: 0.09도
- **속도 제어 범위**: 0-280도/s
- **제어 정밀도**: 1도/s

### 서보모터 영점 수정
서보모터의 영점 각도에 편차가 있을 때 영점을 보정할 수 있습니다.

### 서보모터 잠금/해제
- **잠금 시**: 서보모터가 외력을 받아도 움직이지 않습니다 (외력이 서보모터의 최대 출력 토크를 초과하지 않는 한)
- **해제 시**: 서보모터가 외력을 받으면 움직입니다 (외력이 감속기 자체 저항보다 작지 않은 한)

### 서보모터 상태 조회
이 명령으로 버스 내 서보모터의 ID 및 해당 위치를 조회할 수 있습니다.

### 서보모터 ID 수정
이 명령으로 서보모터의 ID를 수정할 수 있습니다.

### 참고사항:
- **360도 12비트 정밀도**는 360도를 2^12 (4096)등분으로 세분화한다는 의미로, 센서의 정밀도가 (360 ÷ 4096 ≈ 0.09도) 수준에 도달할 수 있습니다.
- 하나의 CAN 버스에 여러 서보모터를 연결할 수 있으며, 각 서보모터는 고유한 ID 번호를 가집니다. 컨트롤러가 보내는 명령에는 ID 정보가 포함되며, 명령의 ID 번호와 일치하는 서보모터만이 해당 명령을 완전히 수신하고 응답할 수 있습니다.

---

## 하드웨어 준비

### 필요한 부품:
1. **24V 전원, 전선, 커넥터** 등
2. **1세대 UBTECH 서보모터 60kg/25kg**: 1세대 Cruzr 로봇 팔에서 분리한 서보모터 필요 (2세대는 발열량이 높아 비추천)
3. **배선 단자**: 4pin 5264 배선 단자 사용

![서보모터 이미지](./images/servos.png)

### 서보모터 핀 정의:

![핀 정의](./images/pin_definition.png)

노치(홈) 위치에 주의하여 배선하십시오:
- **CANH** → USB to CAN 모듈의 CANH
- **CANL** → USB to CAN 모듈의 CANL

### CAN 통신 모듈:
서보모터와 CAN 통신을 하기 위해서는 적절한 하드웨어(마이크로컨트롤러, USB to CAN 모듈)가 필요합니다. 본 문서의 예제는 모두 PC에서 제어하며, USB to CAN 모듈을 통해 서보모터를 제어합니다. CAN 통신이 가능한 모듈이면 어떤 것이든 사용 가능합니다.

### 하드웨어 배선:

![하드웨어 배선도](./images/wiring_diagram.png)

---

## 상위기 디버깅 및 파라미터 설정

본 문서에서 사용하는 USB to CAN 모듈의 상위기는 설정 모드와 데이터 모드를 가지고 있습니다. 이 모듈을 예로 들어 CAN 버스 파라미터를 설정합니다.

### 설정 단계:
1. 올바른 시리얼 포트를 선택하고 포트를 엽니다
2. 모듈의 현재 파라미터를 읽습니다
3. 아래 그림에 따라 파라미터를 설정합니다

![파라미터 설정](./images/parameter_setting.png)

### 데이터 모드로 진입하여 명령 전송

![데이터 모드](./images/data_mode.png)

---

## 서보모터 통신 프로토콜 해석 및 예제

### 명령 패킷

| 헤더 | 프레임 정보 | ID | 파라미터 |
|------|------------|-------|----------|
| 0xAA | 데이터 길이 | ID 번호 | 해당 파라미터 |

#### 참고:
- 통신 프로토콜에서 **"0x"**는 이어지는 숫자가 16진수(base 16)임을 나타내는 접두사입니다. 예를 들어, "0xFF"는 16진수를 나타내며, "F"는 16진수에서 10진수 15에 해당하므로, "FF"는 (15×16)+15=255를 의미합니다. 마찬가지로 "0x10"은 (1×16)+0=16을 의미합니다.

- 16진수를 사용하는 주요 이유는 이진수를 더 편리하게 표현할 수 있기 때문입니다. 16진수의 각 자리는 정확히 이진수 4자리에 해당합니다. 예를 들어, 이진수 "1111"은 16진수 "F"와 같습니다.

- **이진수(binary)**: 0과 1만 사용하는 계수 시스템. 컴퓨터 시스템에서 널리 사용됩니다.
- **10진수(decimal)**: 일상에서 사용하는 0~9의 숫자를 사용하는 계수 시스템.
- **16진수(hexadecimal)**: 0~9와 A~F(각각 10~15를 나타냄)를 사용하는 계수 시스템.

### 응답 패킷

| 헤더 | 프레임 정보 | ID | 파라미터 | 꼬리 |
|------|------------|-------|----------|------|
| 0xAA | 데이터 길이 | ID 번호 | 해당 파라미터 | 고정 형식 |

명령 패킷에 따라 응답 패킷의 기능 파라미터가 다릅니다.

### 명령 타입

| 기능 명령 | 기능 | 값 | 파라미터 길이(바이트) |
|----------|------|-----|-------------------|
| 운동 제어 | 위치 및 속도 제어 | 0x03 | 4 |
| 정보 읽기 | ID, 위치 조회 | 0x01 | 0 |
| 잠금 | 서보모터 잠금 | 0x11 | 0 |
| 해제 | 서보모터 해제 | 0x2f | 0 |
| ID 수정 | ID 수정 | 0x07 | 5 |

---

### 예제 1: 운동 제어

**목표**: ID 13인 서보모터를 150도/s의 속도로 180도로 이동

**전송**:
```
AA 00 00 05 00 00 00 0D 03 00 08 96 00 00 00 00
```

**수신**:
```
AA 00 00 03 00 00 00 0D 03 04 AA 96 00 00 00 00
```

**해석**:
- `00 00 05`: 데이터 길이 (`03 00 08 96 00`)
- `00 00 00 0D`: 서보모터 ID (0x0D = 13)
- `03`: 기능 명령
- `00 08`: 위치, 0x00 0x08에 해당 (위치 하위 바이트 및 상위 바이트)
  - 10진수로 변환하면 2048
  - 이 통신 프로토콜에서 각도 변환 계산은 시프트가 필요 (하위 바이트가 앞에 오기 때문)
  - 즉, 0x00 0x08이 0x08 0x00으로 변환되고, 10진수로는 2048 (8×16×16 + 0×16 + 0 = 2048)
  - 각도로 변환하면 180도 (2048 × 360 / 4096 = 180도)
- `96 00`: 속도는 150도/s

#### 참고:
- 시리얼 통신에서 16진수 0x00 0x08은 명령에서 순서를 바꿔 0x08 0x00으로 전송해야 합니다. 이는 시리얼 통신에서 데이터가 바이트(byte) 단위로 전송되기 때문입니다.
- 빅 엔디안(big-endian)에서는 상위 바이트가 앞에, 하위 바이트가 뒤에 옵니다.
- 리틀 엔디안(little-endian)에서는 하위 바이트가 앞에, 상위 바이트가 뒤에 옵니다.
- 이 통신 프로토콜은 리틀 엔디안을 사용하므로, 16진수 0x00 0x08은 전송 명령에서 0x08 0x00으로 순서를 바꿔야 합니다.
- Windows 계산기로 진법 변환이 가능합니다 (Hex: 16진수, DEC: 10진수)

---

### 예제 2: 조회

조회 명령은 버스의 모든 서보모터를 조회합니다. 버스에 여러 서보모터가 있으면 여러 응답을 받습니다. 이 예제에서는 버스에 ID 13인 서보모터가 하나 있습니다.

**전송**:
```
AA 00 00 01 00 00 00 00 01 00 00 00 00 00 00 00
```

**수신**:
```
AA 00 00 08 00 00 00 0D 02 03 08 62 60 17 10 10
```

**해석**:
- `01`: 조회 명령
- `00 00 00 0D`: 서보모터 ID
- `03 08`: 서보모터 위치, 179.3도(2040)로 변환 가능

---

### 예제 3: 서보모터 ID 수정

서보모터의 ID를 수정하려면 서보모터의 고유 코드를 입력해야 합니다. 고유 코드를 모르는 경우 두 개의 명령을 전송해야 합니다 — 고유 코드 조회 및 ID 수정. 이 예제에서는 ID 13인 서보모터를 ID 3으로 수정합니다.

#### 먼저 서보모터의 고유 코드 획득:

**전송**:
```
AA 00 00 01 00 00 00 0D 07 00 00 00 00 00 00 00
```

**수신**:
```
AA 00 00 06 00 00 00 0D 08 00 5A 8A 8C 74 10 10
```

**해석**:
- `5A 8A 8C 74`: 서보모터 고유 코드

#### ID 수정:

**전송**:
```
AA 00 00 06 00 00 00 0D 07 03 5A 8A 8C 74 00 00
```

**수신**:
```
AA 00 00 02 00 00 00 03 08 03 5A 8A 8C 74 10 10
```

ID가 13에서 3으로 성공적으로 수정된 것을 확인할 수 있습니다.

---

### 예제 4: 서보모터 잠금과 해제

(서보모터 ID는 13)

#### 잠금:

**전송**:
```
AA 00 00 01 00 00 00 0D 11 00 00 00 00 00 00 00
```

**수신**:
```
AA 00 00 01 00 00 00 0D 12 0D 5A 8A 8C 74 10 10
```

- `11`: 잠금 명령

#### 해제:

**전송**:
```
AA 00 00 01 00 00 00 0D 2f 00 00 00 00 00 00 00
```

**수신**:
```
AA 00 00 01 00 00 00 0D 30 0D 5A 8A 8C 74 10 10
```

- `2f`: 해제 명령

---

## 추가 정보

더 많은 기능을 알고 계시다면 업데이트를 위해 연락 주시기 바랍니다.

---

### 면책 조항
- 일부 자료는 인터넷에서 수집되었습니다
- 본 문서는 참고용으로만 제공됩니다
- 상업적 용도로 사용 금지, 위반 시 모든 책임은 사용자에게 있습니다
- 2023.4.30

---

## 이미지 목록

본 문서에서 참조하는 이미지들은 `images/` 폴더에 저장되어야 합니다:

1. `servo_60kg.png` - 60kg 서보모터 이미지
2. `servo_25kg.png` - 25kg 서보모터 이미지
3. `servos.png` - 서보모터 전체 이미지
4. `pin_definition.png` - 핀 정의 다이어그램
5. `wiring_diagram.png` - 배선 다이어그램
6. `parameter_setting.png` - 파라미터 설정 화면
7. `data_mode.png` - 데이터 모드 화면